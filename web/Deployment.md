# Web Viewer Deployment

This page documents the steps involved in deploying the web viewer.


## Table of Contents
- [GitHub Pages](#github-pages)
- [Custom Domain](#custom-domain)
    - [DNS Setup](#dns-setup)
    - [Test](#test)
- [Custom Headers](#custom-headers)
    - [Deploying Cloudflare Workers](#deploying-cloudflare-workers)
        - [Initial Setup](#initial-setup)
        - [Deploy](#deploy)
        - [Test](#test-1)
    - [Secure Connection](#secure-connection)
    - [URL Forwarding](#url-forwarding)


## GitHub Pages 

The web viewer is hosted by GitHub Pages. The viewer artifacts from a successful build are automatically copied to the
[3dviewer](https://github.com/mdh81/3dviewer) repository by the 
[CICD](https://github.com/mdh81/meshviewer/blob/master/.github/workflows/cicd.yml) workflow. This 3dviewer repo has
GitHub Pages enabled, and any commits to this repo trigger an automatic update of the published artifacts.

## Custom Domain

The custom domain, [3dmodelviewer.org](https://3dmodelviewer.org) is redirected to the site hosted by GitHub Pages.  

### DNS Setup

The web viewer deployment depends on Cloudflare's DNS services to redirect traffic from
[3dmodelviewer.org](https://3dmodelviewer.org) to GitHub Pages of the repository
[3dviewer](https://github.com/mdh81/3dviewer). On GitHub-side the only change required to make this happen is to set a 
custom domain in the [Pages setting](https://github.com/mdh81/3dviewer/settings/pages) of this repository. When a custom
domain is set, GitHub automatically creates the [CNAME file](https://github.com/mdh81/3dviewer/blob/main/CNAME) with the
name of the custom domain and commits that file to the repository  

On the Cloudflare-side, the setup is a little more involved. As per [GitHub custom domain 
documentation](https://tinyurl.com/4ueut9k5), two types of DNS records have to be created for the custom domain:

* A-type records pointing to IP addresses of GitHub Pages
* CNAME-type record pointing to user-specific GitHub subdomain (mdh81.github.io, in my case)

### Test

DNS records take time to propagate and there was no mechanism to notify you when they are in place. Instead, Cloudflare
recommends waiting for 24 hours. After the wait period, DNS records can be tested by issuing the following commands:

```shell
$ dig 3dmodelviewer.org +noall +answer -t A
$ dig www.3dmodelviewer.org +noall +answer -t CNAME
```

## Custom Headers 

As an Emscripten application that uses WebAssembly threads, the web viewer application requires the 
[SharedArrayBuffer](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)
feature to function correctly. In order to support this feature, browsers 
require [cross-origin isolated state](https://web.dev/articles/coop-coep). However, GitHub Pages do not allow the hosted
site to be served with custom HTTP headers to create this state. To address this GitHub Pages limitation, the web viewer
deployment uses Cloudflare's "workers" feature. This feature provides serverless javascript execution that can be 
setup to be triggered on URL requests. 

In the web viewer deployment, a Cloudflare worker intercepts all URL requests on the domain 3dmodelviewer.org and appends
these two HTTP headers:

| Header | Value | 
|--------|-------|
|Cross-Origin-Embedder-Policy|require-corp| 
|Cross-Origin-Opener-Policy|same-origin|

This worker's implementation is in the source file 
[response_headers/src/index.js](https://github.com/mdh81/meshviewer/blob/master/web/response_headers/src/index.js).

### Deploying Cloudflare Workers 

Cloudflare has a web interface to write and test workers, but it is cumbersome to use and seemed buggy 
(it's possible my inexperience with their interface was the cause rather than actual bugs in their software). A more
reliable environment is their command line tool, [wrangler](https://developers.cloudflare.com/workers/wrangler/). 

The following steps are required to set up and use wrangler to deploy workers:

* Get an [API token](https://developers.cloudflare.com/fundamentals/api/get-started/create-token/) from Cloudflare. 
Ensure that the token has "edit" permission for workers, without which existing workers can't be modified by wrangler
* Set environment variable `CLOUDFLARE_API_TOKEN` to the token generated by Cloudflare

#### Initial Setup

* Install and authorize wrangler to update Cloudflare account
```shell
$ npm install wrangler --save-dev
$ wrangler login
```
 * Create new project
```shell
 $ wrangler generate <new project name>
 ```
The newly created project will have an auto-generated file named 
[wrangler.toml](https://github.com/mdh81/meshviewer/blob/master/web/response_headers/wrangler.toml). To associate
a worker with a specific Cloudflare account and to make it operational on a 
[Cloudflare zone](https://developers.cloudflare.com/fundamentals/setup/accounts-and-zones/#zones), this file has to be 
defined with two special configuration entries:

* account_id 
* zone_id

Account- and domain-specific values for these entries can be found in the Cloudflare dashboard. Refer to this 
[Cloudflare documentation](https://developers.cloudflare.com/fundamentals/setup/find-account-and-zone-ids/) on where to 
find this information in the dashboard

#### Deploy

```shell
$ wrangler deploy
```

If the API token is set up correctly via `CLOUDFLARE_API_TOKEN` and if the token has correct permissions to update 
workers, the above command should deploy changes to the worker successfully. Changes to workers seem to take effect
instantaneously.

#### Test

Cloudflare's dashboard provides a way to test workers, but again, I found it to be cumbersome to use. It is simpler to
use `curl` to verify that expected headers are present in the document

```shell
$ curl -I https://www.3dmodelviewer.org -H "Cache-Control: no-cache"
```

If all the setup steps above were executed correctly, the output should contain these two header entries:

```
cross-origin-embedder-policy: require-corp
cross-origin-opener-policy: same-origin
 ```

### Secure Connection

In addition to [cross-origin isolated state](https://web.dev/articles/coop-coep), use of 
[SharedArrayBuffer](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer),
also requires the web viewer to be served over HTTPS. To default to using secure connection, the web viewer deployment
relies on Cloudfare's [Page Rules](https://developers.cloudflare.com/rules/page-rules/) feature. One of the page rules
that Cloudflare supports is called "Always use HTTPS". Page rules can be created and updated from Cloudfare's dashboard.


### URL forwarding

Web viewer deployment, specifically, the use of Cloudflare workers to set custom headers relies on the use of a 
canonical URL so that the route definition for our 
[custom header worker](https://github.com/mdh81/meshviewer/blob/master/web/response_headers/wrangler.toml) can be
simplified to use just that canonical URL instead of defining entries for all acceptable URL variations.
The canonical URL for the web viewer is https://www.3dmodelviewer.org and all requests are forwarded to this URL by using Cloudflare's
[forwarding URL page rule](https://developers.cloudflare.com/rules/page-rules/how-to/url-forwarding/)  
